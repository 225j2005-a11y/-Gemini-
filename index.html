<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>时光宝盒</title>
  <meta name="theme-color" content="#6C63FF" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="时光宝盒" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  /-Gemini-/manifest.json
  <link rel="apple-touch-icon" sizes="180x180" href="/-Gemini-/apple-touch-icon.v2.png   html { font-size: 16px; }
    body { line-height: 1.7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f8fafc; margin: 0; padding: 0; color: #334155; }
    #app { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
    .card { background: #fff; border-radius: 16px; padding: 16px; margin: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid #6C63FF; }
    .btn { border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-weight: bold; }
    .btn-primary { background: #6C63FF; color: #fff; }
    textarea, input, select { width: 100%; box-sizing: border-box; padding: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>

<body class="bg-slate-50">
  <div id="app">
    <!-- 顶部 -->
    <header class="sticky top-0 z-50 p-4 bg-white/80 backdrop-blur-md border-b flex justify-between items-center">
      <h1 class="text-xl font-bold text-slate-800">时光宝盒 ✨</h1>
      <div class="flex gap-2">
        <button onclick="openModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl shadow-lg active:scale-95 transition">
          记笔记
        </button>
        <button id="exportBtn" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl">导出</button>
        <button id="importBtn" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl">导入</button>
      </div>
    </header>

    <!-- 过滤器 -->
    <div class="flex gap-2 overflow-x-auto p-4 no-scrollbar">
      <button onclick="filterNotes('全部')" class="px-4 py-1 bg-white border rounded-full text-sm">全部</button>
      <button onclick="filterNotes('心理慰藉')" class="px-4 py-1 bg白 border rounded-full text-sm">心理</button>
      <button onclick="filterNotes('就职建议')" class="px-4 py-1 bg白 border rounded-full text-sm">就职</button>
      <button onclick="filterNotes('学校生活')" class="px-4 py-1 bg白 border rounded-full text-sm">学校</button>
      <button onclick="filterNotes('个人随笔')" class="px-4 py-1 bg白 border rounded-full text-sm">随笔</button>
    </div>

    <!-- 快速粘贴保存 -->
    <div class="card">
      <p class="text-slate-600">把聊天记录粘贴到下面，点击“保存”。会保存在手机本地。</p>
      <textarea id="quickPaste" placeholder="在这里粘贴聊天记录..." rows="5"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn btn-primary" onclick="quickSave()">保存</button>
        <button class="btn" onclick="document.getElementById('quickPaste').value=''">清空</button>
      </div>
    </div>

    <!-- 列表 -->
    <div id="notesList" class="p-2"></div>
  </div>

  <!-- 弹窗 -->
  <div id="noteModal" class="fixed inset-0 bg黑/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
    <div class="bg白 w-full max-w-md rounded-3xl p-6 shadow-2xl">
      <h2 class="text-xl font-bold mb-4">记录此刻</h2>
      <input type="text" id="noteTitle" placeholder="标题" />
      <select id="noteCategory">
        <option value="心理慰藉">心理慰藉</option>
        <option value="就职建议">就职建议</option>
        <option value="学校生活">学校生活</option>
        <option value="个人随笔">个人随笔</option>
      </select>
      <textarea id="noteContent" rows="5" placeholder="写下你想说的话..."></textarea>
      <div class="flex gap-2">
        <button onclick="closeModal()" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold">取消</button>
        <button onclick="addNote()" class="flex-1 py-3 bg-indigo-600 text白 rounded-xl font-bold">保存</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'jia_notes_v4';
    let currentFilter = '全部';

    // -------- 工具函数（安全转义）--------
    function escapeHtml(str) {
      return String(str).replace(/[&<>"]/g, c => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' }[c]));
    }

    // -------- 初始化数据（为空时写入欢迎记录）--------
    function initData() {
      let notes = [];
      try { notes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { notes = []; }
      if (!notes.length) {
        notes = [{
          id: Date.now(),
          title: "欢迎使用时光宝盒",
          category: "心理慰藉",
          content: "这是你的离线安全宝盒。所有数据都保存在你的手机浏览器里（localStorage），不会上传到任何地方。",
          date: new Date().toLocaleDateString()
        }];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
      }
      render();
    }

    // -------- 渲染 --------
    function render() {
      const list = document.getElementById('notesList');
      let notes = [];
      try { notes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { notes = []; }
      const filtered = currentFilter === '全部' ? notes : notes.filter(n => n.category === currentFilter);

      if (!filtered.length) {
        list.innerHTML = `<div class="card">暂无记录。点击右上角“记笔记”添加。</div>`;
        return;
      }

      list.innerHTML = filtered.map(n => `
        <div class="bg白 p-5 rounded-2xl shadow-sm border-l-4 border-indigo-500 mb-4">
          <div class="flex justify-between text-[10px] text-slate-400 mb-2">
            <span>${escapeHtml(n.category)}</span>
            <span>${escapeHtml(n.date)}</span>
          </div>
          <h3 class="font-bold text-slate-800 mb-2">${escapeHtml(n.title)}</h3>
          <p class="text-sm text-slate-600 whitespace-pre-wrap">${escapeHtml(n.content)}</p>
          <div class="flex justify-end mt-4 gap-3">
            <button onclick="copyNote(${n.id})" class="text-indigo-600 text-xs">复制</button>
            <button onclick="editNote(${n.id})" class="text-slate-600 text-xs">编辑</button>
            <button onclick="deleteNote(${n.id})" class="text-red-400 text-xs">删除</button>
          </div>
        </div>
      `).join('');
    }

    // -------- 过滤 --------
    function filterNotes(cat) { currentFilter = cat; render(); }

    // -------- 添加/编辑/删除/复制 --------
    function openModal() { document.getElementById('noteModal').classList.remove('hidden'); }
    function closeModal() { document.getElementById('noteModal').classList.add('hidden'); }

    function addNote() {
      const title = document.getElementById('noteTitle').value || '碎碎念';
      const content = document.getElementById('noteContent').value;
      const category = document.getElementById('noteCategory').value;
      if (!content.trim()) return;

      let notes = [];
      try { notes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { notes = []; }
      notes.unshift({ id: Date.now(), title, content, category, date: new Date().toLocaleDateString() });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));

      closeModal();
      render();
      document.getElementById('noteTitle').value = '';
      document.getElementById('noteContent').value = '';
    }

    function editNote(id) {
      let notes = [];
      try { notes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { notes = []; }
      const idx = notes.findIndex(n => n.id === id);
      if (idx < 0) return;
      const newText = prompt('编辑内容：', notes[idx].content);
      if (newText != null) {
        notes[idx].content = newText;
        notes[idx].date = new Date().toLocaleDateString();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
        render();
      }
    }

    function deleteNote(id) {
      if (!confirm('确定删除吗？')) return;
      let notes = [];
      try { notes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { notes = []; }
      notes = notes.filter(n => n.id !== id);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
      render();
    }

    function copyNote(id) {
      let notes = [];
      try { notes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { notes = []; }
      const item = notes.find(n => n.id === id);
      if (!item) return;

      const text = `${item.title}\n${item.category} · ${item.date}\n\n${item.content}`;
      navigator.clipboard?.writeText(text).then(
        () => alert('已复制到剪贴板'),
        () => { // iOS 兜底
          const t = document.createElement('textarea'); t.value = text;
          document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
          alert('已尝试复制，请检查剪贴板');
        }
      );
    }

    // -------- 导出/导入（备份）--------
    document.getElementById('exportBtn').onclick = () => {
      let notes = [];
      try { notes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { notes = []; }
      const data = JSON.stringify(notes, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = '时光宝盒备份.json'; a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById('importBtn').onclick = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = async () => {
        const file = input.files[0]; if (!file) return;
        const text = await file.text();
        try {
          const arr = JSON.parse(text);
          if (Array.isArray(arr)) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
            render();
            alert('导入成功');
          } else {
            alert('文件格式不正确');
          }
        } catch {
          alert('解析失败，请确认是导出的 JSON 文件');
        }
      };
      input.click();
    };

    // -------- 快速粘贴保存 --------
    function quickSave() {
      const val = document.getElementById('quickPaste').value.trim();
      if (!val) { alert('请输入或粘贴内容'); return; }
      let notes = [];
      try { notes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { notes = []; }
      notes.unshift({ id: Date.now(), title: '碎碎念', category: '个人随笔', content: val, date: new Date().toLocaleDateString() });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
      document.getElementById('quickPaste').value = '';
      render();
      alert('已保存到本地');
    }

    // -------- 注册 Service Worker（GitHub Pages 项目页建议绝对路径）--------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/-Gemini-/sw.js')
          .then(() => console.log('SW registered'))
          .catch(err => console.log('SW registration failed', err));
      });
    }

    // 启动（一定要有这行，且放在所有函数定义之后）
    initData();
  </script>
</body>
</html>
